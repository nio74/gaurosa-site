// Schema Database gaurosa.it
// Per sviluppo locale: MySQL
// Per produzione: Hostinger MySQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================
// PRODOTTI (cache da MazGest)
// ============================================

model Product {
  id          Int     @id @default(autoincrement())
  mazgestId   Int     @unique @map("mazgest_id")
  code        String  @unique @db.VarChar(50)
  ean         String? @db.VarChar(50)
  name        String  @db.VarChar(255)
  slug        String  @unique @db.VarChar(255)
  description String? @db.Text
  loadType    String? @map("load_type") @db.VarChar(50) // orologi, gioielleria, carico_peso, etc.

  // === CATEGORIZZAZIONE (per filtri) ===
  mainCategory String? @map("main_category") @db.VarChar(50) // gioielli, orologi, oggettistica, accessori
  subcategory  String? @db.VarChar(100) // anello, bracciale, collana, etc.

  // === BRAND (per filtro) ===
  brandId Int?   @map("brand_id")
  brand   Brand? @relation(fields: [brandId], references: [id])

  // === FORNITORE (per filtro) ===
  supplierId Int?      @map("supplier_id")
  supplier   Supplier? @relation(fields: [supplierId], references: [id])

  // === PREZZI ===
  price          Decimal  @db.Decimal(10, 2)
  compareAtPrice Decimal? @map("compare_at_price") @db.Decimal(10, 2)

  // === STOCK ===
  stock       Int    @default(0)
  stockStatus String @default("in_stock") @map("stock_status") @db.VarChar(20)

  // === ATTRIBUTI MATERIALE (per filtri) ===
  materialPrimary     String?  @map("material_primary") @db.VarChar(50) // oro_750, argento_925, platino
  materialColor       String?  @map("material_color") @db.VarChar(30) // giallo, bianco, rosa
  materialWeightGrams Decimal? @map("material_weight_grams") @db.Decimal(8, 3)

  // === ATTRIBUTI PIETRE (per filtri) ===
  stoneMainType        String?  @map("stone_main_type") @db.VarChar(50) // diamante, rubino, zaffiro
  stoneMainCarats      Decimal? @map("stone_main_carats") @db.Decimal(6, 3)
  stoneMainColor       String?  @map("stone_main_color") @db.VarChar(30)
  stoneMainClarity     String?  @map("stone_main_clarity") @db.VarChar(10) // IF, VVS1, VS1, SI1
  stoneMainCut         String?  @map("stone_main_cut") @db.VarChar(30)
  stoneMainCertificate String?  @map("stone_main_certificate") @db.VarChar(100)
  stonesSecondaryType  String?  @map("stones_secondary_type") @db.VarChar(50)
  stonesSecondaryCount Int?     @map("stones_secondary_count")

  // === ATTRIBUTI PERLE ===
  pearlType   String?  @map("pearl_type") @db.VarChar(50) // akoya, south_sea, tahiti
  pearlSizeMm Decimal? @map("pearl_size_mm") @db.Decimal(4, 1)
  pearlColor  String?  @map("pearl_color") @db.VarChar(30)

  // === MISURE (per filtri) ===
  sizeRingIt     Int?     @map("size_ring_it") // Misura anello (5-35)
  sizeBraceletCm Decimal? @map("size_bracelet_cm") @db.Decimal(4, 1)
  sizeNecklaceCm Int?     @map("size_necklace_cm")
  sizeEarringMm  Decimal? @map("size_earring_mm") @db.Decimal(5, 1)

  // === TIPO GIOIELLO SPECIFICO (per filtri avanzati) ===
  ringType     String? @map("ring_type") @db.VarChar(50) // solitario, trilogy, fedina
  ringStyle    String? @map("ring_style") @db.VarChar(50)
  earringType  String? @map("earring_type") @db.VarChar(50) // punto_luce, cerchio
  braceletType String? @map("bracelet_type") @db.VarChar(50) // tennis, rigido
  necklaceType String? @map("necklace_type") @db.VarChar(50) // girocollo, collier
  pendantType  String? @map("pendant_type") @db.VarChar(50)

  // === ATTRIBUTI OROLOGI ===
  watchGender   String? @map("watch_gender") @db.VarChar(20) // uomo, donna, unisex
  watchType     String? @map("watch_type") @db.VarChar(50) // analogico, digitale
  watchMovement String? @map("watch_movement") @db.VarChar(50) // quarzo, automatico

  // === CONDIZIONE ===
  itemCondition String? @default("nuovo") @map("item_condition") @db.VarChar(20)

  // === SEO E DESCRIZIONI ===
  seoTitle       String? @map("seo_title") @db.VarChar(255)
  seoDescription String? @map("seo_description") @db.Text
  descriptionIt  String? @map("description_it") @db.Text
  descriptionEn  String? @map("description_en") @db.Text

  // === STATO ===
  isActive   Boolean @default(true) @map("is_active")
  isFeatured Boolean @default(false) @map("is_featured")

  // === TIMESTAMPS ===
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  syncedAt  DateTime? @map("synced_at")

  // === RELAZIONI ===
  images     ProductImage[]
  variants   ProductVariant[]
  orderItems OrderItem[]

  @@index([mainCategory])
  @@index([subcategory])
  @@index([brandId])
  @@index([supplierId])
  @@index([materialPrimary])
  @@index([stoneMainType])
  @@index([stockStatus])
  @@index([isActive])
  @@index([slug])
  @@index([price])
  @@map("products")
}

model ProductImage {
  id        Int     @id @default(autoincrement())
  productId Int     @map("product_id")
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  url       String  @db.VarChar(500)
  isPrimary Boolean @default(false) @map("is_primary")
  sortOrder Int     @default(0) @map("sort_order")

  @@index([productId])
  @@map("product_images")
}

model ProductVariant {
  id        Int     @id @default(autoincrement())
  productId Int     @map("product_id")
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  mazgestVariantId Int?    @map("mazgest_variant_id")
  sku              String? @db.VarChar(100)
  name             String? @db.VarChar(100) // es: "Misura 14"

  // Attributo variante (es: misura anello)
  attributeName  String? @map("attribute_name") @db.VarChar(50)
  attributeValue String? @map("attribute_value") @db.VarChar(50)

  // Varianti virtuali (anelli)
  isVirtual       Boolean @default(false) @map("is_virtual")
  parentVariantId Int?    @map("parent_variant_id")

  price Decimal? @db.Decimal(10, 2)
  stock Int      @default(0)

  @@index([productId])
  @@index([sku])
  @@map("product_variants")
}

// ============================================
// CATEGORIE
// ============================================

model Category {
  id           Int     @id @default(autoincrement())
  name         String  @db.VarChar(100)
  slug         String  @unique @db.VarChar(100)
  description  String? @db.Text
  imageUrl     String? @map("image_url") @db.VarChar(500)
  parentId     Int?    @map("parent_id")
  position     Int     @default(0)
  productCount Int     @default(0) @map("product_count")
  showInMenu   Boolean @default(true) @map("show_in_menu")
  isActive     Boolean @default(true) @map("is_active")

  @@index([parentId])
  @@index([isActive])
  @@index([showInMenu])
  @@map("categories")
}

// ============================================
// BRAND (per filtro)
// ============================================

model Brand {
  id        Int     @id @default(autoincrement())
  mazgestId Int?    @unique @map("mazgest_id")
  name      String  @db.VarChar(100)
  slug      String  @unique @db.VarChar(100)
  logo      String? @db.VarChar(500)
  isActive  Boolean @default(true) @map("is_active")
  sortOrder Int     @default(0) @map("sort_order")

  products Product[]

  @@index([isActive])
  @@map("brands")
}

// ============================================
// FORNITORI (per filtro)
// ============================================

model Supplier {
  id        Int     @id @default(autoincrement())
  mazgestId Int?    @unique @map("mazgest_id")
  name      String  @db.VarChar(200)
  slug      String  @unique @db.VarChar(200)
  isActive  Boolean @default(true) @map("is_active")

  products Product[]

  @@index([isActive])
  @@map("suppliers")
}

// ============================================
// VALORI FILTRI (per popolare dropdown)
// Tabella che memorizza i valori unici per ogni attributo filtrabile
// ============================================

model FilterValue {
  id            Int     @id @default(autoincrement())
  attributeType String  @map("attribute_type") @db.VarChar(50) // main_category, subcategory, material_primary, stone_type, etc.
  value         String  @db.VarChar(100) // Valore originale (oro_750, diamante, etc.)
  label         String  @db.VarChar(100) // Label visualizzata (Oro 750, Diamante, etc.)
  slug          String  @db.VarChar(100) // Per URL (/gioielli?materiale=oro-750)
  sortOrder     Int     @default(0) @map("sort_order")
  productCount  Int     @default(0) @map("product_count") // Conteggio prodotti con questo valore
  isActive      Boolean @default(true) @map("is_active")

  @@unique([attributeType, value])
  @@index([attributeType])
  @@index([isActive])
  @@map("filter_values")
}

// ============================================
// CLIENTI (con autenticazione e dati fiscali)
// ============================================

model Customer {
  id        Int  @id @default(autoincrement())
  mazgestId Int? @unique @map("mazgest_id")

  // === DATI BASE ===
  email     String  @unique @db.VarChar(255)
  firstName String? @map("first_name") @db.VarChar(100)
  lastName  String? @map("last_name") @db.VarChar(100)
  phone     String? @db.VarChar(50)

  // === AUTENTICAZIONE ===
  password          String?   @db.VarChar(255) // Hash bcrypt (null = guest checkout)
  emailVerified     Boolean   @default(false) @map("email_verified")
  emailVerifiedAt   DateTime? @map("email_verified_at")
  verificationToken String?   @unique @map("verification_token") @db.VarChar(100)
  tokenExpiresAt    DateTime? @map("token_expires_at")

  // === DATI FISCALI (per fatture) ===
  customerType    String?  @default("privato") @map("customer_type") @db.VarChar(20) // privato, azienda
  ragioneSociale  String?  @map("ragione_sociale") @db.VarChar(255) // Per aziende
  codiceFiscale   String?  @map("codice_fiscale") @db.VarChar(16)
  partitaIva      String?  @map("partita_iva") @db.VarChar(11)
  codiceSdi       String?  @map("codice_sdi") @db.VarChar(7) // Codice univoco SDI
  pec             String?  @db.VarChar(255) // PEC per fatturazione elettronica

  // === INDIRIZZO FATTURAZIONE ===
  billingAddress  String? @map("billing_address") @db.VarChar(255)
  billingCity     String? @map("billing_city") @db.VarChar(100)
  billingProvince String? @map("billing_province") @db.VarChar(10)
  billingPostcode String? @map("billing_postcode") @db.VarChar(20)
  billingCountry  String? @default("IT") @map("billing_country") @db.VarChar(2)

  // === INDIRIZZO SPEDIZIONE (se diverso) ===
  shippingAddress  String? @map("shipping_address") @db.VarChar(255)
  shippingCity     String? @map("shipping_city") @db.VarChar(100)
  shippingProvince String? @map("shipping_province") @db.VarChar(10)
  shippingPostcode String? @map("shipping_postcode") @db.VarChar(20)
  shippingCountry  String? @map("shipping_country") @db.VarChar(2)

  // === PREFERENZE ===
  marketingConsent Boolean   @default(false) @map("marketing_consent")
  consentedAt      DateTime? @map("consented_at")

  // === ORIGINE E SYNC ===
  fromWebsite   Boolean   @default(true) @map("from_website") // true = registrato online
  syncedAt      DateTime? @map("synced_at") // Quando sincronizzato con MazGest
  syncStatus    String    @default("pending") @map("sync_status") @db.VarChar(20) // pending, synced, error
  lastSyncError String?   @map("last_sync_error") @db.Text

  // === TIMESTAMPS ===
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  lastLoginAt DateTime? @map("last_login_at")

  // === RELAZIONI ===
  orders        Order[]
  refreshTokens RefreshToken[]
  passwordResets PasswordReset[]

  @@index([emailVerified])
  @@index([syncStatus])
  @@index([fromWebsite])
  @@map("customers")
}

// ============================================
// TOKEN REFRESH (per sessioni sicure)
// ============================================

model RefreshToken {
  id         Int      @id @default(autoincrement())
  customerId Int      @map("customer_id")
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  token     String   @unique @db.VarChar(255)
  userAgent String?  @map("user_agent") @db.VarChar(500)
  ipAddress String?  @map("ip_address") @db.VarChar(45)

  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  revokedAt DateTime? @map("revoked_at")

  @@index([customerId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

// ============================================
// PASSWORD RESET TOKENS
// ============================================

model PasswordReset {
  id         Int      @id @default(autoincrement())
  customerId Int      @map("customer_id")
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  token     String   @unique @db.VarChar(100)
  expiresAt DateTime @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([customerId])
  @@index([token])
  @@map("password_resets")
}

// ============================================
// ORDINI
// ============================================

model Order {
  id             Int    @id @default(autoincrement())
  orderNumber    String @unique @map("order_number") @db.VarChar(50)
  mazgestOrderId Int?   @map("mazgest_order_id")

  // === CLIENTE ===
  customerId    Int?      @map("customer_id")
  customer      Customer? @relation(fields: [customerId], references: [id])
  customerEmail String    @map("customer_email") @db.VarChar(255)
  customerName  String    @map("customer_name") @db.VarChar(200)
  customerPhone String?   @map("customer_phone") @db.VarChar(50)
  isGuest       Boolean   @default(false) @map("is_guest") // true = ordine senza registrazione

  // === STATO ===
  status        String @default("pending") @db.VarChar(30)
  paymentStatus String @default("pending") @map("payment_status") @db.VarChar(30)

  // === RICHIESTA FATTURA ===
  requiresInvoice Boolean  @default(false) @map("requires_invoice")
  invoiceType     String?  @map("invoice_type") @db.VarChar(20) // privato, azienda
  invoiceRagioneSociale String? @map("invoice_ragione_sociale") @db.VarChar(255)
  invoiceCodiceFiscale  String? @map("invoice_codice_fiscale") @db.VarChar(16)
  invoicePartitaIva     String? @map("invoice_partita_iva") @db.VarChar(11)
  invoiceCodiceSdi      String? @map("invoice_codice_sdi") @db.VarChar(7)
  invoicePec            String? @map("invoice_pec") @db.VarChar(255)
  invoiceGenerated      Boolean @default(false) @map("invoice_generated")
  invoiceNumber         String? @map("invoice_number") @db.VarChar(50)
  invoiceGeneratedAt    DateTime? @map("invoice_generated_at")

  // === INDIRIZZI (JSON) ===
  billingAddress  String? @map("billing_address") @db.Text
  shippingAddress String? @map("shipping_address") @db.Text

  // === TOTALI ===
  subtotal      Decimal @db.Decimal(10, 2)
  shippingTotal Decimal @default(0) @map("shipping_total") @db.Decimal(10, 2)
  taxTotal      Decimal @default(0) @map("tax_total") @db.Decimal(10, 2)
  discountTotal Decimal @default(0) @map("discount_total") @db.Decimal(10, 2)
  total         Decimal @db.Decimal(10, 2)

  // === PAGAMENTO ===
  paymentMethod    String? @map("payment_method") @db.VarChar(50) // stripe, paypal, bank_transfer
  paymentId        String? @map("payment_id") @db.VarChar(255) // Stripe PaymentIntent ID / PayPal Order ID
  paymentReference String? @map("payment_reference") @db.VarChar(100) // CRO per bonifico

  // === SPEDIZIONE ===
  shippingMethod String? @map("shipping_method") @db.VarChar(100)
  trackingNumber String? @map("tracking_number") @db.VarChar(100)
  trackingUrl    String? @map("tracking_url") @db.VarChar(500)

  // === NOTE ===
  customerNotes String? @map("customer_notes") @db.Text
  internalNotes String? @map("internal_notes") @db.Text

  // === TIMESTAMPS ===
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  paidAt      DateTime? @map("paid_at")
  shippedAt   DateTime? @map("shipped_at")
  completedAt DateTime? @map("completed_at")

  // === SYNC CON MAZGEST ===
  sentToMazgest Boolean   @default(false) @map("sent_to_mazgest")
  sentAt        DateTime? @map("sent_at")
  syncError     String?   @map("sync_error") @db.Text

  items OrderItem[]

  @@index([status])
  @@index([paymentStatus])
  @@index([customerId])
  @@index([createdAt])
  @@index([requiresInvoice])
  @@index([isGuest])
  @@map("orders")
}

model OrderItem {
  id      Int   @id @default(autoincrement())
  orderId Int   @map("order_id")
  order   Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId Int?     @map("product_id")
  product   Product? @relation(fields: [productId], references: [id])

  // Snapshot prodotto al momento ordine
  productCode String  @map("product_code") @db.VarChar(50)
  productName String  @map("product_name") @db.VarChar(255)
  variantSku  String? @map("variant_sku") @db.VarChar(100)
  variantName String? @map("variant_name") @db.VarChar(100)

  // Variante virtuale (anelli)
  isVirtualVariant Boolean @default(false) @map("is_virtual_variant")
  orderedSize      String? @map("ordered_size") @db.VarChar(20)

  quantity   Int     @default(1)
  unitPrice  Decimal @map("unit_price") @db.Decimal(10, 2)
  totalPrice Decimal @map("total_price") @db.Decimal(10, 2)

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

// ============================================
// CARRELLO (persistente)
// ============================================

model Cart {
  id         Int    @id @default(autoincrement())
  sessionId  String @unique @map("session_id") @db.VarChar(100)
  customerId Int?   @map("customer_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  expiresAt DateTime @map("expires_at")

  items CartItem[]

  @@index([sessionId])
  @@index([expiresAt])
  @@map("carts")
}

model CartItem {
  id     Int  @id @default(autoincrement())
  cartId Int  @map("cart_id")
  cart   Cart @relation(fields: [cartId], references: [id], onDelete: Cascade)

  productId Int  @map("product_id")
  variantId Int? @map("variant_id")
  quantity  Int  @default(1)

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([cartId, productId, variantId])
  @@map("cart_items")
}

// ============================================
// SYNC LOG
// ============================================

model SyncLog {
  id        Int    @id @default(autoincrement())
  type      String @db.VarChar(50) // products, stock, categories
  direction String @db.VarChar(10) // pull, push
  status    String @db.VarChar(20) // success, error, partial

  itemsTotal     Int @default(0) @map("items_total")
  itemsProcessed Int @default(0) @map("items_processed")
  itemsFailed    Int @default(0) @map("items_failed")

  errorMessage String? @map("error_message") @db.Text
  details      String? @db.Text // JSON con dettagli

  startedAt   DateTime  @default(now()) @map("started_at")
  completedAt DateTime? @map("completed_at")
  durationMs  Int?      @map("duration_ms")

  @@index([type])
  @@index([status])
  @@index([startedAt])
  @@map("sync_logs")
}

// ============================================
// IMPOSTAZIONI
// ============================================

model Setting {
  id        Int      @id @default(autoincrement())
  key       String   @unique @db.VarChar(100)
  value     String?  @db.Text
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("settings")
}
